<!DOCTYPE html>
<html>
<head>
  <title>OpenData x 去去垃圾走</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="css/index.css" rel="stylesheet" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script src="js/gmaps.js"></script>
 
</head>
<body>
 
    <div id="container">
      <header> 
        <div class="wrapper">
          <div class="headerTitle">OpenData x 去去垃圾走</div>
        </div>
      </header>
 
      <div id="operationBox">
        <div class="wrapper">
          <div class="field"> 
            <div id="panelLeft">
              <div class="">輸入地址查詢附近清運資訊</div>
              <div class="selectType">  
                <ul id="typeList">
                  <li class="filled" value="searchByAddress">地址查詢</li>
              <!--    <li value="searchByTime">時間查詢</li>-->
                  <li value="searchBykeyword">垃圾分類</li>
                </ul>        
              </div>
              <div class="fieldBox" id="searchByAddress">
                 <div class="selectBox">
                  起<select name="startTime" class="custom-dropdown"></select>
                  迄<select name="endTime" class="custom-dropdown"></select>
                </div>
                <div class="inputBox">
                  <input type="text" name="address" placeholder="Address">
                  <div class="icon-search submitAddress"><i></i>查詢</div>
                </div>
              </div>
              <!--
              <div class="fieldBox" id="searchByTime">
                <div class="selectBox">
                起<select name="startTime" class="custom-dropdown"></select>
                迄<select name="endTime" class="custom-dropdown"></select>
              </div>
              <div class="icon-search submitTime">查詢</div>
              </div>-->
              <div  class="fieldBox" id="searchBykeyword">
                <div class="inputBox">
                  <input type="text" name="keyword" placeholder="keyword">
                  <div class="icon-search submitKeyword"><i></i>查詢</div>
                </div>
                <div id="keywordResult"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
 
      <div id="contentBox">
        <div class="wrapper">
          <div id="filterIcon">Filter</div>  
          <div id="filterBox">
            <h6>FILTER BY TYPE</h6>
            <div id="filterPanel">
              <ul>
                <li value="general" class="filter-general">一般</li>
                <li value="recylce" class="filter-recylce">回收</li>
                <li value="clothes" class="filter-clothes">舊衣</li>
                <li value="drug" class="filter-drug">藥物</li>
                <li value="foodScrap" class="filter-foodScrap">廚餘</li>
                <li value="trashBox" class="filter-trashBox">垃圾桶</li>
              </ul>
            </div>
          </div>
          <div id="mapBox">

            <div id="map"></div>
          </div>
          <div id="result">
            <ul id="resultList">
              <li class="resultTitle">查詢結果</li>
            </ul>
          </div>
        </div>
      </div>

  <footer>
    <div class="wrapper">
      <div class="footerLeft">
        <div class="developer">Developer</div> 
        Carol | Charlotte | Dinozzo | Jimmy 
      </div>
      <div class="footerRight"></div>
    </div>
  </footer>
  </div>
  <script type="text/template" id="row">
    <%- name %>/<%- address %><br/> 
    <div class='timeField'>
      <% _.each(garbageType, function(i) { %> 
        <span class="<%= i %>Icon"></span>  
      <% }); %>
      <% if(arriveTime!==''){ %> 
        <%= arriveTime %> 
      <% }else if(startTime!==''){ %> 
        <%= startTime %>~<%= endTime %> 
      <% } %> 
    </div>
  </script>
</body>
  <script src="js/underscore-min.js"></script>
  <script src="js/backbone-min.js"></script>
  <script type="text/javascript">
    var map;
    $(function() {
      var app = app || {};
      app.userPosition={lat:"",lng:""};

      app.mainView = Backbone.View.extend({
        el:"#container",
        events:{
          'click #typeList li':'switchSearchType',
          'click #filterIcon':'filterPanel',
          'click #filterPanel ul li':'switchFilterStatus',
          'click .submitAddress':'searchByAddress',
          'click .submitTime':'searchByTime',
          'click .submitKeyword':'searchBykeyword'
        },
        initialize:function(){

          //this.getCurrentLocation();
          //init map
          map = new GMaps({
            el: '#map',
            lat: 25.0336048,
            lng: 121.5654335,
            zoom: 15
          });

          //init selectale
          for(var i=0; i<24;i++){
            $.each(["00","30"],function(index,value){
              var str=i+':'+value;
              $.each(["startTime","endTime"],function(n,m){
                $("select[name="+m+"]").append('<option value="'+str+'">'+str+'</option>');
              });
            });
          }

        },
        getCurrentLocation:function(){
          
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position){
                app.userPosition.lat=position.coords.latitude;
                app.userPosition.lng=position.coords.longitude
                
              });
          } else {
              console.log("Geolocation is not supported by this browser.");
          }
        
        },
        switchSearchType:function(e){
          var $that=$(e.target);
          $('#typeList .filled').removeClass('filled');
          $(".fieldBox").css("display","none");
          $("#"+$that.attr("value")).css("display","block");
          $that.addClass('filled'); 
        },
        filterPanel:function(){
          $("#filterBox").toggleClass("openFilterPanel");
        },
        switchFilterStatus:function(e){
           $(e.target).toggleClass("filled");
            app.searchResult.filterType();

        },
        searchByAddress:function(){
          var address=$('input[name="address"]').val();
          var startTime=$.trim($('select[name="startTime"]').val());
          var endTime=$.trim($('select[name="endTime"]').val());
          var timeStr=(startTime!==endTime)?"&startTime="+startTime+"&endTime="+endTime:"";


          var position;

          var geocoder = new google.maps.Geocoder();
          geocoder.geocode({
            'address': address
          }, function(results, status) {

            if (status == google.maps.GeocoderStatus.OK) {

              position = results[0].geometry.location.toString().replace('(', '').replace(')', '').split(',');

              map.setCenter(Number(position[0]), Number(position[1]));

              
              $.ajax({
                url: '/collectPoint/query?garbageType=all&lat='+Number(position[0])+'&lng='+Number(position[1])+'&square=0.01'+timeStr,
                type:"GET",
                contentType: 'application/json',
                success: function(result){

                  if(result.totalcount>0){

                    app.searchResult=new app.dataMain(result.collectionPoints);

                  }else{
                    //display no result message
                  }
                },
               error:function(xhr, ajaxOptions, thrownError){
              //    alert(xhr.status);
            //      alert(thrownError);
               }
              });


            } else {}
          });


        },
        searchBykeyword:function(){
          var keyword=$.trim($('input[name="keyword"]').val());

          $.ajax({
              url: '/trash/classification?q='+keyword,
              type:"GET",
              contentType: 'application/json',
              dataType:'json',
              success: function(res){

                $("#keywordResult").empty();
                if(res.count!==0){
                   $("#keywordResult").fadeIn();

                   $.each(res.result.results,function(index,object){
                    $.each(["垃圾項目","關鍵字","處理說明","分類大類別","分類子類別","回收時間"],function(i,v){
                      $("#keywordResult").append('<div class="resultRow"><span class="keywordResultTitle">'+v+'</span><span class="resultValue">'+object[v]+'</span></div>');
                    });
                   });


                }else{
                  $("#keywordResult").hide();
                }
              },
             error:function(xhr, ajaxOptions, thrownError){
            //    alert(xhr.status);
          //      alert(thrownError);
             }
          });
        }

      });


      new app.mainView();
 
      app.dataModel = Backbone.Model.extend({
        defaults:{
          "dataSource":"",
          "garbageType" :[],
          "name" : "",
          "address" : "",
          "lng" : "",
          "lat" : "",
          "weekdays" : [],
          "startTime" : "",
          "endTime" : "",
          "arriveTime":"",
          "information":""
        },
        initialize:function(){
          var $that=this;
          switch(this.get("dataSource")){
            case 'trashCars':
              this.set("information","週一、二、四、五、六 : 一般垃圾與廚餘, 週一、五： 平面類：紙類,舊衣類,乾淨塑膠袋, 週二、四、六： 立體類︰乾淨保麗龍, 一般類（瓶罐、容器、小家電等）");
              break;
            case 'foodScrapsPoints':
              this.set("information","週三、日18時至21時, 廚餘專用限時收受點");
              break;
          }
          $.each(["startTime","endTime","information"],function(i,v){
            if($that.get(v)==null){
              $that.set(v,"");
            }
          });

        }
      });
      app.dataCollection= Backbone.Collection.extend({
        model:app.dataModel,
        filterByType:function(selectedType){
          return this.models.filter(function(model) {

            var flag=false;
            $.each(model.get("garbageType"),function(i,v){
              if($.inArray(v, selectedType)!==-1){
                flag=true;
              }
            });

            return flag==true;
          });
        }
      });
      app.dataView= Backbone.View.extend({
        tagName:"li",
        template:_.template($("#row").html()),
        events:{
          "click":"setCenter"
        },
        initialize:function(){

          map.addMarker({
            lat: Number(this.model.get("lat")),
            lng: Number(this.model.get("lng")),
            title: 'Lima',
            infoWindow: {
              content: '<p><b>地點</b>：'+this.model.get("address")+'<br/><b>日期</b>：'+this.model.get("weekdays")+'<br/><b>時間</b>：<span style="color:rgb(203, 33, 33)">'+this.model.get("startTime")+'~'+this.model.get("endTime")+'</span><br/><b>更多資訊</b>：<br/>'+this.model.get("information")+'</p>'
            }
          });
        },
        render:function(){
          this.$el.html(this.template(this.model.toJSON()));
         return this;
        },
        setCenter:function(){
          map.setCenter(Number(this.model.get("lat")), Number(this.model.get("lng")));
          $('html, body').animate({
            scrollTop: $("#mapBox").offset().top + 'px'
          }, 'fast');
        }
      });
      app.dataMain = Backbone.View.extend({
        el:"#resultList",
        initialize: function(models) {

          this.collection= new app.dataCollection(models);
          this.render(this.collection);
        },
        render: function(collection) {
          $("#resultList").empty();
          $("#resultList").prepend('<li class="resultTitle">查詢結果</li>');
          collection.each(function(model) {
            this.renderItem(model);
          }, this);
        },
        renderItem: function(item) {
          var dataView = new app.dataView({
            model: item
          });
          this.$el.append(dataView.render().el);
        },
        filterType:function(){

          var selectedType=[];

           $("#filterPanel .filled").each(function(i,v){
            selectedType.push($(this).attr("value"));
          });
          map.removeMarkers();
          var filterResult=this.collection.filterByType(selectedType);
          this.render(new app.dataCollection(filterResult));           
          

        }
      });
    });
  </script>